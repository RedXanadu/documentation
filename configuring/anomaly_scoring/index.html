<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.85.0"><meta name=description content="CoreRuleSet Documentation"><meta name=author content="CoreRuleSet"><link rel=icon href=/documentation/images/favicon.png type=image/png><title>Anomaly Scoring :: Core Rule Set Documentation</title><link href=/documentation/css/nucleus.css?1637433053 rel=stylesheet><link href=/documentation/css/fontawesome-all.min.css?1637433053 rel=stylesheet><link href=/documentation/css/featherlight.min.css?1637433053 rel=stylesheet><link href=/documentation/css/perfect-scrollbar.min.css?1637433053 rel=stylesheet><link href=/documentation/css/auto-complete.css?1637433053 rel=stylesheet><link href=/documentation/css/theme.css?1637433053 rel=stylesheet><link href=/documentation/css/theme-blue.css?1637433053 rel=stylesheet><link href=/documentation/css/variant.css?1637433053 rel=stylesheet><link href=/documentation/css/print.css?1637433053 rel=stylesheet media=print><script src=/documentation/js/jquery.min.js?1637433053></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=/documentation/configuring/anomaly_scoring/><nav id=sidebar class=showVisitedLinks><div id=header-wrapper><div id=header><a id=logo href=https://coreruleset.github.io/documentation/><img src=https://coreruleset.github.io/documentation//images/logo.png></a></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script src=/documentation/js/lunr.min.js?1637433053></script><script src=/documentation/js/auto-complete.js?1637433053></script><script>var index_url="/documentation/index.json",root_url="/",baseUri=root_url.replace(/\/$/,'')</script><script src=/documentation/js/search.js?1637433053></script></div><div id=homelinks><ul><li><a class=padding href=/documentation/><i class="fas fa-home"></i> Home</a></li></ul></div><div class=highlightable><ul class=topics><li data-nav-id=/documentation/deployment/ title="Getting CRS" class=dd-item><a href=/documentation/deployment/><b>1. </b>Getting CRS<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/documentation/deployment/engine_integration_options/ title="Engine and Integration Options" class=dd-item><a href=/documentation/deployment/engine_integration_options/>Engine and Integration Options<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/deployment/quickstart/ title="OWASP CRS Quickstart" class=dd-item><a href=/documentation/deployment/quickstart/>Quickstart<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/deployment/install/ title="Installing CoreRuleSet" class=dd-item><a href=/documentation/deployment/install/>Extended Install<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/documentation/configuring/ title="How it Works" class="dd-item parent"><a href=/documentation/configuring/><b>2. </b>How it Works<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/documentation/configuring/anomaly_scoring/ title="Anomaly Scoring" class="dd-item active"><a href=/documentation/configuring/anomaly_scoring/>Anomaly Scoring<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/configuring/paranoia_levels/ title="Paranoia Levels" class=dd-item><a href=/documentation/configuring/paranoia_levels/>Paranoia Levels<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/configuring/plugins/ title=Plugins class=dd-item><a href=/documentation/configuring/plugins/>Plugins<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/configuring/crs/ title=Configuration class=dd-item><a href=/documentation/configuring/crs/>Configuration<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/configuring/exceptions/ title="Adding Exceptions and Tuning CRS" class=dd-item><a href=/documentation/configuring/exceptions/>Exceptions<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/documentation/operation/ title=Operation class=dd-item><a href=/documentation/operation/>Operation<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/documentation/operation/containers/ title="Using Containers" class=dd-item><a href=/documentation/operation/containers/>Using Containers<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/operation/log_handling/ title="Log Handling" class=dd-item><a href=/documentation/operation/log_handling/>Log Handling<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/documentation/rules/ title="Creating Rules" class=dd-item><a href=/documentation/rules/><b>3. </b>Rules<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/documentation/rules/ruleid/ title="Rule IDs" class=dd-item><a href=/documentation/rules/ruleid/><b>1. </b>Rule IDs<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/rules/testing/ title="Testing the Rule Set" class=dd-item><a href=/documentation/rules/testing/><b>2. </b>Testing<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/rules/rules/ title=Rules class=dd-item><a href=/documentation/rules/rules/><b>3. </b>Rules<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/rules/creating/ title=Making class=dd-item><a href=/documentation/rules/creating/><b>9. </b>Making<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/rules/metadata/ title=Metadata class=dd-item><a href=/documentation/rules/metadata/><b>10. </b>Metadata<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/documentation/development/ title=Development class=dd-item><a href=/documentation/development/><b>4. </b>Development<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/documentation/development/rule_writing/ title="Writing CRS Rules" class=dd-item><a href=/documentation/development/rule_writing/>Writing CRS Rules<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/development/plugin_writing/ title="Writing Plugins" class=dd-item><a href=/documentation/development/plugin_writing/>Writing Plugins<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/development/sandbox/ title="Using the CRS Sandbox" class=dd-item><a href=/documentation/development/sandbox/>Using the CRS Sandbox<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/documentation/resources/ title="Additional Resources" class=dd-item><a href=/documentation/resources/>Additional Resources<i class="fas fa-check read-icon"></i></a><ul></ul></li><li data-nav-id=/documentation/miscellaneous/ title=Miscellaneous class=dd-item><a href=/documentation/miscellaneous/>Miscellaneous<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/documentation/miscellaneous/self_contained_mode/ title="Self-Contained Mode" class=dd-item><a href=/documentation/miscellaneous/self_contained_mode/>Self-Contained Mode<i class="fas fa-check read-icon"></i></a></li></ul></li></ul><div id=shortcuts><div class=nav-title>More</div><ul><li><a class=padding href=https://coreruleset.org/><i class="fas fa-bookmark"></i> Core Rule Set Home</a></li><li><a class=padding href=https://github.com/coreruleset/coreruleset><i class="fab fa-github"></i> Core Rule Set GitHub</a></li></ul></div><div id=prefooter><hr><ul><li><a class=padding href=# data-clear-history-toggle><i class="fas fa-history fa-fw"></i> Clear History</a></li></ul></div><div id=footer><p>Built with <a href=https://github.com/McShelby/hugo-theme-relearn><i class="fas fa-heart"></i></a> by <a href=https://gohugo.io/>Hugo</a></p></div></div></nav><div id=body><div id=overlay></div><div class="padding highlightable"><div id=top-bar><div id=top-github-link><a class=github-link title="Edit this page" href=https://github.com/coreruleset/documentation/blob/main/content/configuring/anomaly_scoring.md target=blank><i class="fas fa-code-branch"></i>
<span id=top-github-link-text>Edit this page</span></a></div><div id=breadcrumbs><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>Anomaly Scoring</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#overview-of-anomaly-scoring>Overview of Anomaly Scoring</a></li><li><a href=#how-anomaly-scoring-mode-works>How Anomaly Scoring Mode Works</a><ul><li><a href=#summary-of-anomaly-scoring-mode>Summary of Anomaly Scoring Mode</a></li><li><a href=#the-anomaly-scoring-mechanism-in-action>The Anomaly Scoring Mechanism In Action</a></li></ul></li><li><a href=#configuring-anomaly-scoring-mode>Configuring Anomaly Scoring Mode</a><ul><li><a href=#anomaly-score-thresholds>Anomaly Score Thresholds</a></li><li><a href=#severity-levels>Severity Levels</a></li><li><a href=#early-blocking>Early Blocking</a></li></ul></li></ul></nav></div></div></div><div id=head-tags></div><main id=body-inner><h1>Anomaly Scoring</h1><blockquote><p>The Core Rule Set 3 is designed as an anomaly scoring rule set. This page explains what anomaly scoring is and how to use it.</p></blockquote><h2 id=overview-of-anomaly-scoring>Overview of Anomaly Scoring</h2><p>Anomaly scoring, also known as &ldquo;collaborative detection&rdquo;, is a scoring mechanism used in the Core Rule Set. It assigns a numeric score to HTTP transactions (requests and responses), representing how &lsquo;anomalous&rsquo; they appear to be. Anomaly scores can then be used to make blocking decisions. The default CRS blocking policy, for example, is to block any transaction that meets or exceeds a defined anomaly score threshold.</p><h2 id=how-anomaly-scoring-mode-works>How Anomaly Scoring Mode Works</h2><p>Anomaly scoring mode combines the concepts of <em>collaborative detection</em> and <em>delayed blocking</em>. The key idea to understand is that <strong>the inspection/detection rule logic is decoupled from the blocking functionality</strong>.</p><p>Individual rules designed to detect specific types of attacks and malicious behavior are executed. If a rule matches, no immediate disruptive action is taken (e.g. the transaction is not blocked). Instead, the matched rule contributes to a transactional <em>anomaly score</em>, which acts as a running total. The rules just handle detection, adding to the anomaly score if they match. In addition, an individual matched rule will typically log a record of the match for later reference, including the ID of the matched rule, the data that caused the match, and the URI that was being requested.</p><p>Once all of the rules that inspect <em>request</em> data have been executed, <em>blocking evaluation</em> takes place. If the anomaly score is greater than or equal to the inbound anomaly score threshold then the transaction is <em>denied</em>. Transactions that are not denied continue on their journey.</p><p><img src="as_inbound_no_fonts.svg?height=36em" alt="Diagram showing an example where the inbound anomaly score threshold is set to 5. A first example request accumulates an anomaly score of 2 and is allowed to pass at the blocking evaluation step. A second example request accumulates an anomaly score of 7 and is denied at the blocking evaluation step."></p><p>Continuing on, once all of the rules that inspect <em>response</em> data have been executed, a second round of blocking evaluation takes place. If the <em>outbound</em> anomaly score is greater than or equal to the outbound anomaly score threshold then the transaction is <em>denied</em>.</p><div class="notices info"><div class=label>Info</div><p>Having separate inbound and outbound anomaly scores and thresholds allows for request data and response data to be inspected and scored independently.</p></div><h3 id=summary-of-anomaly-scoring-mode>Summary of Anomaly Scoring Mode</h3><p>To summarize, anomaly scoring mode in the CRS works like so:</p><ol><li>Execute all <em>request</em> rules</li><li>Make a blocking decision using the <em>inbound</em> anomaly score threshold</li><li>Execute all <em>response</em> rules</li><li>Make a blocking decision using the <em>outbound</em> anomaly score threshold</li></ol><h3 id=the-anomaly-scoring-mechanism-in-action>The Anomaly Scoring Mechanism In Action</h3><p>As described, individual rules are only responsible for detection and inspection: they do not block or deny transactions. If a rule matches then it increments the anomaly score. This is done using ModSecurity&rsquo;s <code>setvar</code> action.</p><p>Below is an example of a detection rule which matches when a request has a <code>Content-Length</code> header field containing something other than digits. Notice the final line of the rule: it makes use of the <code>setvar</code> action, which will increment the anomaly score if the rule matches:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-apache data-lang=apache>SecRule REQUEST_HEADERS:Content-Length <span style=color:#e6db74>&#34;!@rx ^\d+$&#34;</span> \
    <span style=color:#960050;background-color:#1e0010>&#34;</span>id:920160,\
    phase:1,\
    block,\
    t:none,\
    msg:&#39;Content-Length HTTP header is not numeric&#39;,\
    logdata:&#39;%{MATCHED_VAR}&#39;,\
    tag:&#39;application-multi&#39;,\
    tag:&#39;language-multi&#39;,\
    tag:&#39;platform-multi&#39;,\
    tag:&#39;attack-protocol&#39;,\
    tag:&#39;paranoia-level/1&#39;,\
    tag:&#39;OWASP_CRS&#39;,\
    tag:&#39;capec/1000/210/272&#39;,\
    ver:&#39;OWASP_CRS/3.4.0-dev&#39;,\
    severity:&#39;CRITICAL&#39;,\
    setvar:&#39;tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}&#39;<span style=color:#960050;background-color:#1e0010>&#34;</span>
</code></pre></div><div class="notices info"><div class=label>Info</div><p>Notice that the anomaly score variable name has the suffix <code>pl1</code>. Internally, CRS keeps track of anomaly scores on a <em>per</em> <a href=/documentation/configuring/paranoia_levels/ title="Page describing paranoia levels."><em>paranoia level</em></a> basis. The individual paranoia level anomaly scores are added together before each round of blocking evaluation takes place, allowing the total combined inbound or outbound score to be compared to the relevant anomaly score threshold.</p><p>Tracking the anomaly score per paranoia level allows for clever scoring mechanisms to be employed, such as the <a href=/documentation/configuring/paranoia_levels/#moving-to-a-higher-paranoia-level title="Section describing the executing paranoia level feature.">executing paranoia level</a> feature.</p></div><p>The rules files <code>REQUEST-949-BLOCKING-EVALUATION.conf</code> and <code>RESPONSE-959-BLOCKING-EVALUATION.conf</code> are responsible for executing the inbound (request) and outbound (response) rounds of blocking evaluation, respectively. The rules in these files calculate the total inbound or outbound transactional anomaly score and then make a blocking decision, by comparing the result to the defined threshold and taking blocking action if required.</p><h2 id=configuring-anomaly-scoring-mode>Configuring Anomaly Scoring Mode</h2><p>The following settings can be configured when using anomaly scoring mode:</p><ul><li>Anomaly score thresholds</li><li>Severity levels</li><li>Early blocking</li></ul><p>If using a native Core Rule Set installation on a web application firewall, these settings are defined in the file <code>crs-setup.conf</code>. If running CRS where it has been integrated into a commercial product or CDN then support varies. Some vendors expose these settings in the GUI while other vendors require custom rules to be written which set the necessary variables. Unfortunately, there are also vendors that don&rsquo;t allow these settings to be configured at all.</p><h3 id=anomaly-score-thresholds>Anomaly Score Thresholds</h3><p>An anomaly score threshold is the cumulative anomaly score at which an inbound request or an outbound response will be blocked.</p><p>Most detected inbound threats carry an anomaly score of 5 (by default), while smaller violations, e.g. protocol and standards violations, carry lower scores. An anomaly score threshold of 7, for example, would require multiple rule matches in order to trigger a block (e.g. one &ldquo;critical&rdquo; rule scoring 5 plus a lesser-scoring rule, in order to reach the threshold of 7). An anomaly score threshold of 10 would require at least two &ldquo;critical&rdquo; rules to match, or a combination of many lesser-scoring rules. <strong>Increasing the anomaly score thresholds makes the CRS less sensitive</strong> and hence less likely to block transactions.</p><div class="notices warning"><div class=label>Warning</div><p>Increasing the anomaly score thresholds may allow some attacks to bypass the CRS rules.</p></div><div class="notices tip"><div class=label>Tip</div><p>A common practice when working with a <strong>new</strong> CRS deployment is to start in blocking mode from the very beginning with <em>very high anomaly score thresholds</em> (even as high as 10000). The thresholds can be gradually lowered over time as an iterative process.</p><p>This tuning method was developed and advocated by Christian Folini, who documented it in detail, along with examples, in a popular tutorial titled <a href=https://www.netnea.com/cms/apache-tutorial-8_handling-false-positives-modsecurity-core-rule-set/>Handling False Positives with the OWASP ModSecurity Core Rule Set</a>.</p></div><p>CRS uses two anomaly score thresholds, which can be defined using the variables listed below:</p><table><thead><tr><th>Threshold</th><th>Variable</th></tr></thead><tbody><tr><td>Inbound anomaly score threshold</td><td><code>tx.inbound_anomaly_score_threshold</code></td></tr><tr><td>Outbound anomaly score threshold</td><td><code>tx.outbound_anomaly_score_threshold</code></td></tr></tbody></table><p>A simple way to set these thresholds is to uncomment and use rule 900110:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-apache data-lang=apache>SecAction \
 <span style=color:#960050;background-color:#1e0010>&#34;</span>id:900110,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.inbound_anomaly_score_threshold=5,\
  setvar:tx.outbound_anomaly_score_threshold=4<span style=color:#960050;background-color:#1e0010>&#34;</span>
</code></pre></div><h3 id=severity-levels>Severity Levels</h3><p>Each CRS rule has an associated <em>severity level</em>. Different severity levels have different anomaly scores associated with them. This means that different rules can increment the anomaly score by different amounts if the rules match.</p><p>The four severity levels and their <em>default</em> anomaly scores are:</p><table><thead><tr><th>Severity Level</th><th>Default Anomaly Score</th></tr></thead><tbody><tr><td><strong>CRITICAL</strong></td><td>5</td></tr><tr><td><strong>ERROR</strong></td><td>4</td></tr><tr><td><strong>WARNING</strong></td><td>3</td></tr><tr><td><strong>NOTICE</strong></td><td>2</td></tr></tbody></table><p>For example, by default, a single matching <code>CRITICAL</code> rule would increase the anomaly score by 5, while a single matching <code>WARNING</code> rule would increase the anomaly score by 3.</p><p>The default anomaly scores are rarely ever changed. It is possible, however, to set custom anomaly scores for severity levels. To do so, uncomment rule 900100 and set the anomaly scores as desired:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-apache data-lang=apache>SecAction \
 <span style=color:#960050;background-color:#1e0010>&#34;</span>id:900100,\
  phase:1,\
  nolog,\
  pass,\
  t:none,\
  setvar:tx.critical_anomaly_score=5,\
  setvar:tx.error_anomaly_score=4,\
  setvar:tx.warning_anomaly_score=3,\
  setvar:tx.notice_anomaly_score=2<span style=color:#960050;background-color:#1e0010>&#34;</span>
</code></pre></div><div class="notices info"><div class=label>Info</div><p>The CRS makes use of a ModSecurity feature called <em>macro expansion</em> to propagate the value of the severity level anomaly scores throughout the entire rule set.</p></div><h3 id=early-blocking>Early Blocking</h3><p>TODO</p><footer class=footline></footer></main></div><div id=navigation><a class="nav nav-prev" href=/documentation/configuring/ title="How it Works"><i class="fa fa-chevron-left"></i></a>
<a class="nav nav-next" href=/documentation/configuring/paranoia_levels/ title="Paranoia Levels"><i class="fa fa-chevron-right"></i></a></div></div><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/documentation/js/clipboard.min.js?1637433053></script><script src=/documentation/js/perfect-scrollbar.min.js?1637433053></script><script src=/documentation/js/perfect-scrollbar.jquery.min.js?1637433053></script><script src=/documentation/js/jquery.svg.pan.zoom.js?1637433053></script><script src=/documentation/js/featherlight.min.js?1637433053></script><script src=/documentation/js/modernizr.custom-3.6.0.js?1637433053></script><script src=/documentation/js/mermaid.min.js?1637433053></script><script>typeof mermaid!='undefined'&&mermaid.mermaidAPI.initialize(Object.assign({securityLevel:"antiscript"},JSON.parse('{ "startOnLoad": true }'),{startOnLoad:!1}))</script><script src=/documentation/js/relearn.js?1637433053></script></body></html>