<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.85.0"><meta name=description content="CoreRuleSet Documentation"><meta name=author content="CoreRuleSet"><link rel=icon href=/documentation/images/favicon.png type=image/png><title>Testing the Rule Set :: Core Rule Set Documentation</title><link href=/documentation/css/nucleus.css?1650297448 rel=stylesheet><link href=/documentation/css/fontawesome-all.min.css?1650297448 rel=stylesheet><link href=/documentation/css/featherlight.min.css?1650297448 rel=stylesheet><link href=/documentation/css/perfect-scrollbar.min.css?1650297448 rel=stylesheet><link href=/documentation/css/auto-complete.css?1650297448 rel=stylesheet><link href=/documentation/css/theme.css?1650297448 rel=stylesheet><link href=/documentation/css/theme-blue.css?1650297448 rel=stylesheet><link href=/documentation/css/variant.css?1650297448 rel=stylesheet><link href=/documentation/css/print.css?1650297448 rel=stylesheet media=print><script src=/documentation/js/jquery.min.js?1650297448></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=/documentation/development/testing/><nav id=sidebar class=showVisitedLinks><div id=header-wrapper><div id=header><a id=logo href=https://coreruleset.github.io/documentation/><img src=https://coreruleset.github.io/documentation//images/logo.png></a></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script src=/documentation/js/lunr.min.js?1650297448></script><script src=/documentation/js/auto-complete.js?1650297448></script><script>var index_url="/documentation/index.json",root_url="/",baseUri=root_url.replace(/\/$/,'')</script><script src=/documentation/js/search.js?1650297448></script></div><div id=homelinks><ul><li><a class=padding href=/documentation/><i class="fas fa-home"></i> Home</a></li></ul></div><div class=highlightable><ul class=topics><li data-nav-id=/documentation/deployment/ title="Getting CRS" class=dd-item><a href=/documentation/deployment/><b>1. </b>Getting CRS<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/documentation/deployment/engine_integration_options/ title="Engine and Integration Options" class=dd-item><a href=/documentation/deployment/engine_integration_options/>Engine and Integration Options<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/deployment/quickstart/ title="OWASP CRS Quickstart" class=dd-item><a href=/documentation/deployment/quickstart/>Quickstart<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/deployment/install/ title="Installing CoreRuleSet" class=dd-item><a href=/documentation/deployment/install/>Extended Install<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/documentation/configuring/ title="How it Works" class=dd-item><a href=/documentation/configuring/><b>2. </b>How it Works<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/documentation/configuring/anomaly_scoring/ title="Anomaly Scoring" class=dd-item><a href=/documentation/configuring/anomaly_scoring/>Anomaly Scoring<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/configuring/paranoia_levels/ title="Paranoia Levels" class=dd-item><a href=/documentation/configuring/paranoia_levels/>Paranoia Levels<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/configuring/false_positives_tuning/ title="False Positives and Tuning" class=dd-item><a href=/documentation/configuring/false_positives_tuning/>False Positives and Tuning<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/configuring/plugins/ title="Plugin Mechanism" class=dd-item><a href=/documentation/configuring/plugins/>Plugin Mechanism<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/configuring/sampling_mode/ title="Sampling Mode" class=dd-item><a href=/documentation/configuring/sampling_mode/>Sampling Mode<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/configuring/crs/ title=Configuration class=dd-item><a href=/documentation/configuring/crs/>Configuration<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/documentation/operation/ title=Operation class=dd-item><a href=/documentation/operation/>Operation<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/documentation/operation/containers/ title="Using Containers" class=dd-item><a href=/documentation/operation/containers/>Using Containers<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/operation/log_handling/ title="Log Handling" class=dd-item><a href=/documentation/operation/log_handling/>Log Handling<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/documentation/rules/ title="Creating Rules" class=dd-item><a href=/documentation/rules/><b>3. </b>Rules<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/documentation/rules/ruleid/ title="Rule IDs" class=dd-item><a href=/documentation/rules/ruleid/><b>1. </b>Rule IDs<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/rules/testing/ title="Testing the Rule Set" class=dd-item><a href=/documentation/rules/testing/><b>2. </b>Testing<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/rules/rules/ title=Rules class=dd-item><a href=/documentation/rules/rules/><b>3. </b>Rules<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/rules/creating/ title=Making class=dd-item><a href=/documentation/rules/creating/><b>9. </b>Making<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/rules/metadata/ title=Metadata class=dd-item><a href=/documentation/rules/metadata/><b>10. </b>Metadata<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/documentation/development/ title=Development class="dd-item parent"><a href=/documentation/development/><b>4. </b>Development<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/documentation/development/contribution_guidelines/ title="Contribution Guidelines" class=dd-item><a href=/documentation/development/contribution_guidelines/>Contribution Guidelines<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/development/useful_tools/ title="Useful Tools" class=dd-item><a href=/documentation/development/useful_tools/>Useful Tools<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/development/testing/ title="Testing the Rule Set" class="dd-item active"><a href=/documentation/development/testing/>Testing the Rule Set<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/development/plugin_writing/ title="Writing Plugins" class=dd-item><a href=/documentation/development/plugin_writing/>Writing Plugins<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/development/sandbox/ title="Using the CRS Sandbox" class=dd-item><a href=/documentation/development/sandbox/>Using the CRS Sandbox<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/documentation/resources/ title="Additional Resources" class=dd-item><a href=/documentation/resources/>Additional Resources<i class="fas fa-check read-icon"></i></a><ul></ul></li><li data-nav-id=/documentation/miscellaneous/ title=Miscellaneous class=dd-item><a href=/documentation/miscellaneous/>Miscellaneous<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/documentation/miscellaneous/self_contained_mode/ title="Self-Contained Mode" class=dd-item><a href=/documentation/miscellaneous/self_contained_mode/>Self-Contained Mode<i class="fas fa-check read-icon"></i></a></li></ul></li></ul><div id=shortcuts><div class=nav-title>More</div><ul><li><a class=padding href=https://coreruleset.org/><i class="fas fa-bookmark"></i> Core Rule Set Home</a></li><li><a class=padding href=https://github.com/coreruleset/coreruleset><i class="fab fa-github"></i> Core Rule Set GitHub</a></li></ul></div><div id=prefooter><hr><ul><li><a class=padding href=# data-clear-history-toggle><i class="fas fa-history fa-fw"></i> Clear History</a></li></ul></div><div id=footer><p>Built with <a href=https://github.com/McShelby/hugo-theme-relearn><i class="fas fa-heart"></i></a> by <a href=https://gohugo.io/>Hugo</a></p></div></div></nav><div id=body><div id=overlay></div><div class="padding highlightable"><div id=top-bar><div id=top-github-link><a class=github-link title="Edit this page" href=https://github.com/coreruleset/documentation/blob/main/content/development/testing.md target=blank><i class="fas fa-code-branch"></i>
<span id=top-github-link-text>Edit this page</span></a></div><div id=breadcrumbs><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>Testing the Rule Set</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#setting-up-the-basic-environment>Setting up the basic environment</a></li><li><a href=#start-the-containers>Start the containers</a></li><li><a href=#running-the-test-suite>Running the test suite</a></li><li><a href=#additional-tips>Additional tips</a></li><li><a href=#summary>Summary</a></li></ul></nav></div></div></div><div id=head-tags></div><main id=body-inner><h1>Testing the Rule Set</h1><h1 id=testing-for-rule-developers>Testing for rule developers</h1><p>Well, you managed to write your rule, but now want to see if if can be added to the CRS? This document should help you to test it using the same tooling the project uses for its tests.</p><p>Tests are performed using a Python tool called <a href=https://github.com/coreruleset/ftw>ftw</a>. We run them using a <a href=https://github.com/coreruleset/coreruleset/blob/v3.4/dev/.github/workflows/test.yml>GitHub actions pipeline</a>. You can easily reproduce that locally, in your workstation.</p><p>For that you will need:</p><ul><li>the coreruleset git repository</li><li>docker and docker-compose (modern versions of docker already include compose functionality)</li><li>python3</li><li>your rules and tests!</li></ul><h2 id=setting-up-the-basic-environment>Setting up the basic environment</h2><p>I normally use <a href=https://docs.pipenv.org/>pipenv</a> whenever Python is involved. It will give you both isolation and dependencies at once. But you can use basic pip and virtualenv and the result will be the same.</p><p>For installing the python tooling, just use:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>❯ pipenv install -r tests/regression/requirements.txt
Creating a virtualenv <span style=color:#66d9ef>for</span> this project...
Pipfile: /private/tmp/coreruleset/Pipfile
Using /usr/local/bin/python3 <span style=color:#f92672>(</span>3.9.5<span style=color:#f92672>)</span> to create virtualenv...
⠧ Creating virtual environment...created virtual environment CPython3.9.5.final.0-64 in 392ms
  creator CPython3Posix<span style=color:#f92672>(</span>dest<span style=color:#f92672>=</span>/Users/fzipitria/.local/share/virtualenvs/coreruleset-UNJnkEXP, clear<span style=color:#f92672>=</span>False, global<span style=color:#f92672>=</span>False<span style=color:#f92672>)</span>
  seeder FromAppData<span style=color:#f92672>(</span>download<span style=color:#f92672>=</span>False, pip<span style=color:#f92672>=</span>bundle, setuptools<span style=color:#f92672>=</span>bundle, wheel<span style=color:#f92672>=</span>bundle, via<span style=color:#f92672>=</span>copy, app_data_dir<span style=color:#f92672>=</span>/Users/fzipitria/Library/Application Support/virtualenv<span style=color:#f92672>)</span>
    added seed packages: pip<span style=color:#f92672>==</span>21.0.1, setuptools<span style=color:#f92672>==</span>56.0.0, wheel<span style=color:#f92672>==</span>0.36.2
  activators BashActivator,CShellActivator,FishActivator,PowerShellActivator,PythonActivator,XonshActivator

✔ Successfully created virtual environment!
Virtualenv location: /Users/fzipitria/.local/share/virtualenvs/coreruleset-UNJnkEXP
Creating a Pipfile <span style=color:#66d9ef>for</span> this project...
Requirements file provided! Importing into Pipfile...
Pipfile.lock not found, creating...
Locking <span style=color:#f92672>[</span>dev-packages<span style=color:#f92672>]</span> dependencies...
Locking <span style=color:#f92672>[</span>packages<span style=color:#f92672>]</span> dependencies...
Building requirements...
Resolving dependencies...
✔ Success!
Updated Pipfile.lock <span style=color:#f92672>(</span>02e6ae<span style=color:#f92672>)</span>!
Installing dependencies from Pipfile.lock <span style=color:#f92672>(</span>02e6ae<span style=color:#f92672>)</span>...
  🐍   ▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉▉ 17/17 — 00:00:28
To activate this project<span style=color:#960050;background-color:#1e0010>&#39;</span>s virtualenv, run pipenv shell.
Alternatively, run a command inside the virtualenv with pipenv run.
</code></pre></div><p>Now we are ready to start running tests.</p><h2 id=start-the-containers>Start the containers</h2><p>For testing, we use the <a href=https://github.com/coreruleset/modsecurity-crs-docker>docker images from our project</a>. That way we can easily use the base containers. But, we &ldquo;bind mount&rdquo; the rules in the git repository. So that will allow you to easily test any rules you want inside the containers.</p><p>To test we need two containers: the WAF itself, and a backend provided by the <a href=http://httpbin.org>http://httpbin.org</a> project. That is we we use <code>docker-compose</code>, so we can run and connect them easily.</p><p>-> The supported platform is modsecurity 2 with Apache</p><p>Let&rsquo;s start the containers using:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>❯ docker-compose -f tests/docker-compose.yml up -d modsec2-apache
Docker Compose is now in the Docker CLI, try <span style=color:#e6db74>`</span>docker compose up<span style=color:#e6db74>`</span>

Creating network <span style=color:#e6db74>&#34;tests_default&#34;</span> with the default driver
Creating tests_backend_1 ... <span style=color:#66d9ef>done</span>
Creating modsec2-apache  ... <span style=color:#66d9ef>done</span>
❯ docker ps
CONTAINER ID   IMAGE                              COMMAND                  CREATED          STATUS         PORTS                               NAMES
785a6f6a3cb6   owasp/modsecurity-crs:3.3-apache   <span style=color:#e6db74>&#34;/docker-entrypoint.…&#34;</span>   <span style=color:#ae81ff>7</span> seconds ago    Up <span style=color:#ae81ff>3</span> seconds   0.0.0.0:80-&gt;80/tcp, :::80-&gt;80/tcp   modsec2-apache
bb8d5a7f256d   kennethreitz/httpbin               <span style=color:#e6db74>&#34;gunicorn -b 0.0.0.0…&#34;</span>   <span style=color:#ae81ff>10</span> seconds ago   Up <span style=color:#ae81ff>7</span> seconds   80/tcp                              tests_backend_1
</code></pre></div><p>Excellent, our containers are running, now we can start our tests.</p><h2 id=running-the-test-suite>Running the test suite</h2><p>The test suite will be run by the tool <code>ftw</code>, now that we started our containers.</p><p>If you used the <code>pipenv</code> tool for installing the module, now is time to enter the shell:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>❯ py.test -vs --tb<span style=color:#f92672>=</span>short tests/regression/CRS_Tests.py --config<span style=color:#f92672>=</span>modsec2-apache --ruledir_recurse<span style=color:#f92672>=</span>./tests/regression/tests
<span style=color:#f92672>==============================================================================</span> test session starts <span style=color:#f92672>===============================================================================</span>
platform darwin -- Python 3.9.5, pytest-4.6.0, py-1.10.0, pluggy-0.13.1 -- /Users/fzipitria/.local/share/virtualenvs/coreruleset-bLfwOI0B/bin/python
cachedir: .pytest_cache
rootdir: /Users/fzipitria/Workspace/OWASP/coreruleset
plugins: ftw-1.2.4
collected <span style=color:#ae81ff>2468</span> items

tests/regression/CRS_Tests.py::test_crs<span style=color:#f92672>[</span>ruleset0-933210.yaml -- 933210-1<span style=color:#f92672>]</span> PASSED
tests/regression/CRS_Tests.py::test_crs<span style=color:#f92672>[</span>ruleset1-933210.yaml -- 933210-2<span style=color:#f92672>]</span> PASSED
tests/regression/CRS_Tests.py::test_crs<span style=color:#f92672>[</span>ruleset2-933210.yaml -- 933210-3<span style=color:#f92672>]</span> PASSED
tests/regression/CRS_Tests.py::test_crs<span style=color:#f92672>[</span>ruleset3-933210.yaml -- 933210-4<span style=color:#f92672>]</span> PASSED
tests/regression/CRS_Tests.py::test_crs<span style=color:#f92672>[</span>ruleset4-933210.yaml -- 933210-5<span style=color:#f92672>]</span> PASSED
tests/regression/CRS_Tests.py::test_crs<span style=color:#f92672>[</span>ruleset5-933210.yaml -- 933210-6<span style=color:#f92672>]</span> PASSED
tests/regression/CRS_Tests.py::test_crs<span style=color:#f92672>[</span>ruleset6-933210.yaml -- 933210-7<span style=color:#f92672>]</span> PASSED
tests/regression/CRS_Tests.py::test_crs<span style=color:#f92672>[</span>ruleset7-933210.yaml -- 933210-8<span style=color:#f92672>]</span> PASSED
tests/regression/CRS_Tests.py::test_crs<span style=color:#f92672>[</span>ruleset8-933210.yaml -- 933210-9<span style=color:#f92672>]</span> PASSED
tests/regression/CRS_Tests.py::test_crs<span style=color:#f92672>[</span>ruleset9-933210.yaml -- 933210-10<span style=color:#f92672>]</span> PASSED
tests/regression/CRS_Tests.py::test_crs<span style=color:#f92672>[</span>ruleset10-933210.yaml -- 933210-11<span style=color:#f92672>]</span> PASSED
tests/regression/CRS_Tests.py::test_crs<span style=color:#f92672>[</span>ruleset11-933210.yaml -- 933210-12<span style=color:#f92672>]</span> PASSED
tests/regression/CRS_Tests.py::test_crs<span style=color:#f92672>[</span>ruleset12-933210.yaml -- 933210-13<span style=color:#f92672>]</span> PASSED
...
</code></pre></div><p>Couple notes here:</p><ul><li>using <code>--ruledir_recurse=./tests/regression/tests</code> will walk over all the tests defined below that directory</li><li>you can test your specific file using <code>--rule=./mytest.yaml</code></li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>❯ py.test -vs --tb<span style=color:#f92672>=</span>short tests/regression/CRS_Tests.py --config<span style=color:#f92672>=</span>modsec2-apache --rule<span style=color:#f92672>=</span>./mytest.yaml
<span style=color:#f92672>==============================================================================</span> test session starts <span style=color:#f92672>===============================================================================</span>
platform darwin -- Python 3.9.5, pytest-4.6.0, py-1.10.0, pluggy-0.13.1 -- /Users/fzipitria/.local/share/virtualenvs/coreruleset-bLfwOI0B/bin/python
cachedir: .pytest_cache
rootdir: /Users/fzipitria/Workspace/OWASP/coreruleset
plugins: ftw-1.2.4
collected <span style=color:#ae81ff>1</span> item

tests/regression/CRS_Tests.py::test_crs<span style=color:#f92672>[</span>ruleset0-mytest.yaml -- mytest-1<span style=color:#f92672>]</span> PASSED

<span style=color:#f92672>================================================================================</span> warnings summary <span style=color:#f92672>================================================================================</span>
/Users/fzipitria/.local/share/virtualenvs/coreruleset-bLfwOI0B/lib/python3.9/site-packages/yaml/constructor.py:126
  /Users/fzipitria/.local/share/virtualenvs/coreruleset-bLfwOI0B/lib/python3.9/site-packages/yaml/constructor.py:126: DeprecationWarning: Using or importing the ABCs from <span style=color:#e6db74>&#39;collections&#39;</span> instead of from <span style=color:#e6db74>&#39;collections.abc&#39;</span> is deprecated since Python 3.3, and in 3.10 it will stop working
    <span style=color:#66d9ef>if</span> not isinstance<span style=color:#f92672>(</span>key, collections.Hashable<span style=color:#f92672>)</span>:

-- Docs: https://docs.pytest.org/en/latest/warnings.html
<span style=color:#f92672>======================================================================</span> <span style=color:#ae81ff>1</span> passed, <span style=color:#ae81ff>1</span> warnings in 0.36 seconds <span style=color:#f92672>======================================================================</span>
</code></pre></div><p>That&rsquo;s it!</p><h2 id=additional-tips>Additional tips</h2><p>⚠️ If your test is not matching, you can take a peek at the <code>modsec_audit.log</code> file, using: <code>sudo tail -200 tests/logs/modsec2-apache/modsec_audit.log</code></p><p>🔧 If you need to write a test that cannot be written using text (e.g. binary content), we prefer using <code>encoded_request</code> in the test, using base64 encoding</p><h2 id=summary>Summary</h2><p>Tests are a core functionality in our ruleset. So whenever you write a rule, try to add some positive and negative tests so we won&rsquo;t have surprises in the future.</p><p>Happy testing! 🎉</p><footer class=footline></footer></main></div><div id=navigation><a class="nav nav-prev" href=/documentation/development/useful_tools/ title="Useful Tools"><i class="fa fa-chevron-left"></i></a>
<a class="nav nav-next" href=/documentation/development/plugin_writing/ title="Writing Plugins"><i class="fa fa-chevron-right"></i></a></div></div><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/documentation/js/clipboard.min.js?1650297448></script><script src=/documentation/js/perfect-scrollbar.min.js?1650297448></script><script src=/documentation/js/perfect-scrollbar.jquery.min.js?1650297448></script><script src=/documentation/js/jquery.svg.pan.zoom.js?1650297448></script><script src=/documentation/js/featherlight.min.js?1650297448></script><script src=/documentation/js/modernizr.custom-3.6.0.js?1650297448></script><script src=/documentation/js/mermaid.min.js?1650297448></script><script>typeof mermaid!='undefined'&&mermaid.mermaidAPI.initialize(Object.assign({securityLevel:"antiscript"},JSON.parse('{ "startOnLoad": true }'),{startOnLoad:!1}))</script><script src=/documentation/js/relearn.js?1650297448></script><script>var _paq=window._paq=window._paq||[];_paq.push(['trackPageView']),_paq.push(['enableLinkTracking']),function(){var b="https://piwik.netnea.com/matomo/",c,a,d;_paq.push(['setTrackerUrl',b+'matomo.php']),_paq.push(['setSiteId','4']),c=document,a=c.createElement('script'),d=c.getElementsByTagName('script')[0],a.async=!0,a.src=b+'matomo.js',d.parentNode.insertBefore(a,d)}()</script><img referrerpolicy=no-referrer-when-downgrade src="https://piwik.netnea.com/matomo/matomo.php?idsite=4&rec=1" style=border:0 alt></body></html>